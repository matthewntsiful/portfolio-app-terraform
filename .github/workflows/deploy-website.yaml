name: Deploy Website to S3

on:
  push:
    branches:
      - 'main'
      - 'devops-engineers'
      - 'web-developers'
    paths:
      - 'website/**'
      - '.github/workflows/deploy-website.yaml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - invalidate-cache

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: "us-east-1"
  TF_WORKING_DIR: "terraform/infra"

jobs:
  deploy:
    name: Deploy Website
    runs-on: ubuntu-latest
    environment: ${{ contains(github.ref, 'main') && 'production' || 'staging' }}
    outputs:
      bucket-name: ${{ steps.deploy-step.outputs.bucket-name }}
      cloudfront-url: ${{ steps.invalidate-step.outputs.cloudfront-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: github-actions-deploy

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
        aws --version

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Dependencies
      working-directory: website
      run: |
        echo "Installing npm dependencies..."
        npm install --no-audit
        echo "Dependencies installed successfully"

    - name: Build Website
      working-directory: website
      run: |
        echo "Building React application for production..."
        # Try common build script names
        if npm run | grep -q "build:prod"; then
          npm run build:prod
        elif npm run | grep -q "build"; then
          npm run build
        else
          echo "âŒ No build script found. Available scripts:"
          npm run
          exit 1
        fi
        
        echo "Build completed successfully"
        echo "Checking build output directory..."
        
        # Check for common build output directories
        if [ -d "dist" ]; then
          BUILD_DIR="dist"
        elif [ -d "build" ]; then
          BUILD_DIR="build"
        else
          echo "âŒ No build output directory found"
          echo "Available directories:"
          ls -la
          exit 1
        fi
        
        echo "Build directory: $BUILD_DIR"
        echo "Build contents:"
        ls -la $BUILD_DIR/
        echo "Checking for index.html:"
        test -f $BUILD_DIR/index.html && echo "âœ… index.html found" || echo "âŒ index.html missing"
        
        # Export build directory for next steps
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

    - name: Deploy to S3
      id: deploy-step
      if: github.event.inputs.action != 'invalidate-cache'
      working-directory: website
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        
        echo "ðŸš€ Deploying to S3 bucket: $BUCKET_NAME"
        
        # Validate prerequisites
        [ -z "$BUCKET_NAME" ] && { echo "âŒ S3_BUCKET_NAME not set"; exit 1; }
        [ ! -d "$BUILD_DIR" ] && { echo "âŒ Build directory missing"; exit 1; }
        
        cd $BUILD_DIR
        
        # Upload files directly to S3 bucket root
        echo "Syncing HTML files..."
        aws s3 sync . s3://$BUCKET_NAME/ \
          --cache-control "no-cache, no-store, must-revalidate" \
          --exclude "*" \
          --include "*.html" \
          --delete
        
        echo "Syncing CSS and JS files..."
        aws s3 sync . s3://$BUCKET_NAME/ \
          --cache-control "public, max-age=604800" \
          --exclude "*" \
          --include "*.css" \
          --include "*.js"
        
        echo "Syncing static assets..."
        aws s3 sync . s3://$BUCKET_NAME/ \
          --cache-control "public, max-age=2592000" \
          --exclude "*" \
          --include "*.png" --include "*.jpg" --include "*.jpeg" \
          --include "*.svg" --include "*.ico" --include "*.json" \
          --include "*.pdf" --include "*.woff" --include "*.woff2"
        
        echo "Syncing asset directories..."
        aws s3 sync . s3://$BUCKET_NAME/ \
          --cache-control "public, max-age=2592000" \
          --exclude "*" \
          --include "assets/**" \
          --include "css/**" \
          --include "js/**" \
          --include "styles/**" \
          --include "components/**" \
          --include "images/**"
        
        echo "Final sync for remaining files..."
        aws s3 sync . s3://$BUCKET_NAME/ \
          --cache-control "public, max-age=86400"
        
        echo "âœ… Deployment completed successfully!"
        echo "bucket-name=$BUCKET_NAME" >> $GITHUB_OUTPUT

    - name: Invalidate CloudFront Cache
      id: invalidate-step
      if: github.event.inputs.action == 'invalidate-cache' || github.event_name == 'push' || github.event.inputs.action == 'deploy'
      run: |
        DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
        
        if [ -n "$DISTRIBUTION_ID" ]; then
          echo "Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "Invalidation created with ID: $INVALIDATION_ID"
          
          sleep 5
          
          aws cloudfront get-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID \
            --query 'Invalidation.Status' \
            --output text
          
          CLOUDFRONT_URL=$(aws cloudfront get-distribution \
            --id $DISTRIBUTION_ID \
            --query 'Distribution.DomainName' \
            --output text)
          
          echo "cloudfront-url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "CloudFront URL: https://$CLOUDFRONT_URL"
          echo "Your website should be available at: https://${{ vars.DOMAIN_NAME || 'your-domain.com' }}"
        else
          echo "No CloudFront distribution ID provided, skipping invalidation"
        fi

  notify:
    name: 'Notify Deployment Status'
    needs: [deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Check Job Status
      id: check_status
      run: |
        if [[ "${{ needs.deploy.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "emoji=âœ…" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "emoji=âŒ" >> $GITHUB_OUTPUT
        fi

    - name: Send Slack Notification
      if: vars.SLACK_NOTIFICATIONS_ENABLED == 'true'
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_COLOR: ${{ steps.check_status.outputs.status == 'success' && 'good' || 'danger' }}
        SLACK_TITLE: "Website Deployment ${{ steps.check_status.outputs.status == 'success' && 'Succeeded' || 'Failed' }}"
        SLACK_MESSAGE: |
          ${{ steps.check_status.outputs.emoji }} **Deployment Status**: ${{ steps.check_status.outputs.status == 'success' && 'SUCCESS' || 'FAILED' }}
          
          **Details:**
          â€¢ *Environment*: ${{ contains(github.ref, 'main') && 'Production' || 'Staging' }}
          â€¢ *Action*: ${{ github.event.inputs.action || 'deploy' }}
          â€¢ *Triggered by*: ${{ github.actor }}
          â€¢ *Branch*: `${{ github.ref_name }}`
          â€¢ *Commit*: `${{ github.sha }}`
          
          **Infrastructure:**
          â€¢ *AWS Region*: ${{ env.AWS_REGION }}
          â€¢ *S3 Bucket*: ${{ needs.deploy.outputs.bucket-name || 'N/A' }}
          ${{ needs.deploy.outputs.cloudfront-url && format('â€¢ *CloudFront*: https://{0}', needs.deploy.outputs.cloudfront-url) || 'â€¢ *CloudFront*: Not configured' }}
          
          **Links:**
          â€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>
          ${{ needs.deploy.outputs.bucket-name && format('â€¢ <https://{0}.s3-website-{1}.amazonaws.com|S3 Website>', needs.deploy.outputs.bucket-name, env.AWS_REGION) || '' }}
        SLACK_USERNAME: GitHub Actions Bot
        SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        SLACK_FOOTER: "${{ github.workflow }} #${{ github.run_number }} â€¢ ${{ github.repository }}"